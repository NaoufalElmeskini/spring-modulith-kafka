# Makefile pour le TP Kafka
.PHONY: help build start stop clean logs topic-create topic-info

help: ## Affiche l'aide
	@echo "ğŸ¯ TP Kafka - Commandes disponibles :"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

build: ## Build les applications Java
	@echo "ğŸ”¨ Build du Producer..."
	cd kafka-producer && mvn clean package -DskipTests
	@echo "ğŸ”¨ Build du Consumer..."
	cd kafka-consumer && mvn clean package -DskipTests
	@echo "âœ… Build terminÃ© !"

start-infra: ## DÃ©marre Kafka et Zookeeper
	@echo "ğŸš€ DÃ©marrage de l'infrastructure Kafka..."
	docker-compose up -d zookeeper kafka kafka-ui
	@echo "â³ Attente du dÃ©marrage de Kafka..."
	sleep 30

topic-create: ## CrÃ©e le topic sensor-data
	@echo "ğŸ“ CrÃ©ation du topic 'sensor-data'..."
	chmod +x create-topic.sh
	./create-topic.sh

start-apps: ## DÃ©marre les applications Producer et Consumer
	@echo "ğŸš€ DÃ©marrage des applications..."
	docker-compose up -d kafka-producer kafka-consumer
	@echo "âœ… Applications dÃ©marrÃ©es !"

start: build start-infra topic-create start-apps ## DÃ©marre tout le projet
	@echo "ğŸ‰ Projet dÃ©marrÃ© avec succÃ¨s !"
	@echo "ğŸ“Š Kafka UI disponible sur : http://localhost:8080"
	@echo "ğŸ“ Consultez les logs avec : make logs"

stop: ## ArrÃªte tous les containers
	@echo "ğŸ›‘ ArrÃªt des containers..."
	docker-compose down
	@echo "âœ… Containers arrÃªtÃ©s !"

clean: stop ## Nettoie tout (containers, volumes, images)
	@echo "ğŸ§¹ Nettoyage complet..."
	docker-compose down -v --rmi local
	@echo "âœ… Nettoyage terminÃ© !"

logs: ## Affiche les logs du Producer et Consumer
	@echo "ğŸ“‹ Logs en temps rÃ©el (Ctrl+C pour arrÃªter) :"
	docker-compose logs -f kafka-producer kafka-consumer

logs-producer: ## Affiche les logs du Producer uniquement
	docker logs -f kafka-producer

logs-consumer: ## Affiche les logs du Consumer uniquement
	docker logs -f kafka-consumer

logs-kafka: ## Affiche les logs de Kafka
	docker logs -f kafka

topic-info: ## Affiche les infos du topic
	@echo "ğŸ“‹ Informations sur le topic 'sensor-data' :"
	docker exec kafka kafka-topics --describe --topic sensor-data --bootstrap-server localhost:9092

topic-messages: ## Affiche les messages du topic (depuis le dÃ©but)
	@echo "ğŸ“¨ Messages du topic 'sensor-data' :"
	docker exec kafka kafka-console-consumer --topic sensor-data --bootstrap-server localhost:9092 --from-beginning --max-messages 10

status: ## Affiche l'Ã©tat des containers
	@echo "ğŸ“Š Ã‰tat des containers :"
	docker-compose ps

restart: ## RedÃ©marre les applications
	@echo "ğŸ”„ RedÃ©marrage des applications..."
	docker-compose restart kafka-producer kafka-consumer
	@echo "âœ… Applications redÃ©marrÃ©es !"